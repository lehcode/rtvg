<?php 
/**
 * View script for channel list
 * or channel category list
 * 
 * @author  Antony Repin
 * @package rutvgid
 * @version $Id: list.phtml,v 1.15 2013-02-15 00:44:02 developer Exp $
 *
 */

$categoryTitle = isset($this->category['title']) && !empty($this->category['title']) ? $this->escape( $this->category['title'] ) : null ;
$categoryAlias = isset($this->category['alias']) && !empty($this->category['alias']) ? $this->escape( $this->category['alias'] ) : null ;

if ($categoryTitle) {
	$this->headTitle( $this->category['title'].' телеканалы: передачи сегодня и на текущей неделе.' );
	$this->headMeta()->setName('title', 'Телепрограмма '.$this->category['title'].' каналов');
} else {
	$this->headTitle( 'Программа всех каналов телевидения на сегодня и текущую неделю.' );
	$this->headMeta()->setName('title', 'Телепрограмма всех каналов');
}


APPLICATION_ENV=='production' ? 
	$this->headScript()->appendFile( $this->baseUrl( 'js/tip/jquery.tooltip.min.js')) : 
	$this->headScript()->appendFile( $this->baseUrl( 'js/tip/jquery.tooltip.js'));

/**
 * Load scripts
 */
$this->headScript()
	->appendScript("$(function() { $('#fastsearch-wrap img').tooltip({ showURL: false });
	$.getJSON( '/channels/typeahead/format/json/c/".$categoryAlias."', function(response) {
		var typeahead_items = new Array();
		$.each(response, function(key, val) { 
			$.each(val, function(name, channel){  typeahead_items.push(channel.title); }); 
		});
		$('input[name=searchinput]').typeahead({ source:typeahead_items });
		$('input[name=searchinput]').blur(function(){ 
			if ($(this).val() != '') {
				$('ul.typeahead li').click(function(){
					$('.channeltitle').each(function(){
						var r = new RegExp($('ul.typeahead li.active').attr('data-value'), 'i');
						if (currentTitle = $(this).html().match(r)) {
							$(\"html:not(:animated),body:not(:animated)\").animate({ scrollTop: $(this).offset().top }, 1000);
							return false;
						}
					});
				});
			}
		});
		
	});
	$( '#channels' ).accordion({ autoHeight:false, navigation:true, clearStyle:true, icons: false });
	
});");

?>

 
<div id="fastsearch-wrap">
	<?php 
	$tip = "Начните вводить название канала и выберите его из списка. Окно браузера автоматически переместится к выбранному каналу.";
	if ($this->category) {
	  $tip .=" Если канала нет в категории <i>".$categoryTitle."</i>, наберите его название или часть названия и нажмите Перейти.";  
	} 
	?>
	<img class="tip" src="/images/icons/tip-12x12.png" title="<?php echo $tip ?>" />
	<?php 
	$form = new Xmltv_Form_TypeaheadForm(); 
	echo $form; 
	?>
</div>


	
<?php 
if ( isset($this->category) && $this->category!==null) {
	//img src="$this->baseUrl('images/categories/channels/'.$this->escape( $this->category['image']) ); " />
	echo '<h2>'.$categoryTitle.' каналы'.'</h2>';
	printf('<p class="label label-info">Телеканалы в категории «%s»: %d</p>', $categoryTitle, count($this->channels)) ;
} else {
	echo '<h2>Все каналы</h2>';
	printf('<p class="label label-info">Всего %d</p>', count($this->channels)) ;
} ?>



<div id="channels">

	<?php
	foreach ($this->channels as $channel) { 
		$id	= $channel['id'];
		$title = $channel['title'];
		$alias = $channel['alias'];
		$icon  = $channel['icon'];
		?>
	
	<h3 class="channeltitle" id="#channeltitle<?php echo $id ?>">
		<img class="channelicon" 
			width="40" 
			src="<?php echo $icon; ?>" 
			alt="<?php printf('%s лого', Xmltv_String::strtolower($title)) ?>" />
		<?php echo $channel['title'] ?>
	</h3>
	
	<div class="channeldesc">
		<a class="label" 
			href="<?php echo $this->url(array('channel'=>Xmltv_String::strtolower($alias)), 'default_listings_day-listing'); ?>" 
			title="<?php printf('Телепрограмма канала %s на сегодня', $title) ?>">
			<?php printf('Передачи %s сегодня', $channel['title']) ?>
		</a>
		<a class="label label-info" 
			href="<?php echo $this->url(array('channel'=>Xmltv_String::strtolower($alias)), 'default_channels_channel-week'); ?>" 
			title="<?php printf('Телепрограмма канала %s на неделю', $channel['title']) ?>">
			Программа на неделю
		</a>
		
		<p>
			<?php echo $this->escape( strip_tags($channel['desc_intro']) ) ?>
		</p>
		<p>
			<?php echo $this->truncateString( strip_tags($channel['desc_body']), 20, 'words'); ?>
		</p>
	</div>

	<?php 
	}
	?>
</div>
