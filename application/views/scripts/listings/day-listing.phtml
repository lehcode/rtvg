<?php 
/**
 * Day listing script for channel
 * 
 * @author  Antony Repin
 * @package rutvgid
 * @version $Id: day-listing.phtml,v 1.32 2013-04-11 05:21:11 developer Exp $
 *
 */

$channelTitle = $this->escape( $this->channel['title'] );
$channelAlias = $this->escape( $this->channel['alias'] );
//$channelCat   = $this->escape( $this->channel['channel_category'] );

$this->headMeta()->setName('description', sprintf ('Передачи сегодня на канале «%s»', $channelTitle ));

$js = "$(function(){
	var minHeight = 0;
	$('#programlist .item').each(function(){
		var p      = $(this).find('p.description');
		$(this).find('.inner').append($('<a/>').attr({ 'href':'#' }).html('Полностью'));
		var height = $(this).height();
		if (height<minHeight){
			minHeight = height;
		}
	});
	console.log(minHeight);
});";
$js = (APPLICATION_ENV=='production') ? Rtvg_Compressor_JSMin::minify($js): $js ;
$this->headScript()->appendScript($js);


$css="#content.day-listing .top form {
	margin: 0;
}
";
$this->headStyle()->appendStyle($css);
?>

<div class="container-fluid">
	<h1 class="span8"><?php printf('«%s» %s', $channelTitle, Xmltv_String::strtolower( $this->listing_date->toString("EEEE, d MMMM YYYY"))); ?></h1>
	<span class="span2" id="timer">Сейчас<br /><?php echo $this->listing_date->toString("HH:mm") ?> (MSK)</span>
</div>

<div class="container-fluid top">
	<?php 
	if ($this->is_today){
		/*
		 * Change time zone
		 */
		echo new Xmltv_Form_TimezoneSwitch( array(
			'action'   => '',
			'name'     => 'timezone',
			'method'   => 'get',
			'id'       => 'timezone',
			'enctype'  => 'application/x-www-form-urlencoded',
			'label'    => array( 'class' => 'smallheading' ),
			'html_tag' => array( 'tag'=>'div', 'class'=>'module span1' ),
			'diff'     => $this->timeshift,
		));
	}
	
	/*
	 * Change channel autocomplete form
	 */
	echo new Xmltv_Form_TypeaheadForm( array(
		'method'   => 'post',
		'enctype'  => 'application/x-www-form-urlencoded',
		'name'     => 'typeahead',
		'scroll'   => false,
		'html_tag' => array( 'tag' => 'div', 'class' => 'module span4' ),
		'input'    => array( 
			'style' => 'width:100%;', 
			'label' => 'Быстрый поиск канала',
			'id'    => 'searchinput',
			'html_tag' => array(
					'tag'=>'div'
			)
		),
		'ajax_tracking' => true
	)); 
	?>
	
</div>

<div class="container-fluid">
	<?php 
	if (!$this->is_today) {
		$linkAttrHref  = $this->url(array('channel'=>$channelAlias), 'default_listings_day-listing');
		$linkAttrTitle = $this->escape( sprintf('Телепрограмма «%s» на сегодня', $channelTitle) );
		$linkText = sprintf ('«%s» сегодня', $channelTitle);
		?>
	<h2>
		<a href="<?php echo $linkAttrHref; ?>" title="<?php echo $linkAttrTitle; ?>" class="btn"><strong><?php echo $linkText; ?></strong></a>
	</h2>
	<?php 
	} ?>
	
	
	<h3>
		<?php 
		$linkAttrHref  = $this->url( array('channel'=>$channelAlias), 'default_channels_channel-week' );
		$linkAttrTitle = $this->escape( sprintf('Передачи «%s» на неделю', $channelTitle) );
		$linkText      = $this->escape( sprintf ('Программа передач "%s" на всю неделю', $channelTitle) );
		?>
		<a href="<?php echo $linkAttrHref; ?>" title="<?php echo $linkAttrTitle; ?>" class="btn week-link">
			<?php echo $linkText; ?>
		</a>
	</h3>
	
	
	<?php
	if ($this->is_today) {
	$js = "$(function(){ $('#DIV_DA_126314 table').hide(); });";
	$this->headScript()->appendScript($js);
	?>
	<div id="DIV_DA_126314" class="advm"></div>
	<?php } ?>
	
</div>


<?php 
if ($this->is_today) {
    echo $this->partial( 'listings/partials/programlist.phtml', array( 
		'items'          => $this->programs, 
		'channel'        => $this->channel, 
		'listing_videos' => $this->listing_videos, 
		'is_today'       => $this->is_today, 
		'short_link'     => $this->short_link,
    	'listing_date'   => $this->listing_date,
	)); 
} else {
    echo $this->partial( 'listings/partials/programtable.phtml', array(
    	'items'        => $this->programs,
    	'channel'      => $this->channel,
    	'listing_date' => $this->listing_date,
    ));
}
?>

<?php 
if (isset($this->comments) && !empty($this->comments)) { 
    ?>
    <div id="comments">

        <h4><?php echo $this->escape( sprintf('В блогах  про %s', $this->channel['title']) ); ?></h4>

            <?php
            if (isset($this->comments) && (bool)$this->comments!==false) {
                foreach ($this->comments as $comment) {
                    ?>

            <div>

                <?php if (!empty($comment['author'])) : ?>
                <div class="author">
                    <a href="<?php echo $comment['src_url']  ?>" rel="nofollow" target="_blank">
                        <small><?php echo $comment['author'] ?></small>
                    </a>
                </div>
                <?php endif; ?>

                <p class="description">
                    <?php 
                    $desc =  str_ireplace( $this->channel['title'], '<em>'.$this->channel['title'].'</em>', $comment['intro']);
                    echo $this->truncateString($desc, 20, 'words', false);
                    ?>
                </p>


            </div>
                <?php 
                }
            }
            ?>
            <a href="<?php //echo $this->url(array(), 'default_comments_create'); ?>">Добавить комментарий</a>

        <div class="copy3rdparty">
            <a href="http://blogs.yandex.ru/" title="Yandex поиск по блогам" rel="nofollow"><img src="http://img.yandex.net/i/logo100x43.png" width="37" height="16" /></a>
        </div>
    </div>
    <?php 
} ?>
