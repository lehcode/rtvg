<?php 
/**
 * Day listing script for channel
 * 
 * @author  Antony Repin
 * @package rutvgid
 * @version $Id: day-listing.phtml,v 1.7 2012-05-27 20:05:50 dev Exp $
 *
 */
$this->headScript()
	->appendFile($this->baseUrl()."/js/bootstrap-carousel.js")
	->appendFile($this->baseUrl()."/js/listing-day.js");

$this->is_today=false;
$date = new Zend_Date(null, null, 'ru');
if ($this->today->toString('yyyy-MM-dd')==$date->toString('yyyy-MM-dd')) 
$this->is_today=true;

$tolower = new Zend_Filter_StringToLower();

if ($this->is_today) {
	$this->headMeta()->setName('title', sprintf ('Программа телеканала %s на сегодня', $this->channel->title));
} else {
	$this->headMeta()->setName('title', sprintf ('Программа канала %s на %s', $this->channel->title, $this->today->toString('EEEE, d MMMM YYYY')));
}
$kw = array($tolower->filter( $this->channel->title ), $this->today->toString('d MMMM YYYY'));
$this->headMeta()->setName('keywords', implode(',', $kw).','.Xmltv_Config::getKeywords() );

if ($this->is_today) {
	$this->headTitle( sprintf ('%s сегодня', $this->channel->title ) );
} else {
	$this->headTitle( sprintf ('%s %s', $this->channel->title, $this->today->toString( 'EEEE, d MMMM YYYY' ) ) );
}

$channel_alias = Xmltv_String::strtolower($this->channel->alias);
$css = ".carousel-inner { }";
$this->headStyle()->appendStyle($css);

?>
<div id="fast_search">
	<?php $form = new Xmltv_Form_FastChannelSearchForm(); echo $form; ?>
</div>
<h1><?php printf('Канал %s сегодня', $this->channel->title) ?></h1>
<p><?php echo Xmltv_String::ucfirst( $this->today->toString("EEEE, d MMMM YYYY") ); ?></p>
<p><a class="btn week" title="<?php printf('Перейти к расписанию программ канала "%s" на неделю', $this->channel->title); ?>" href="/телепрограмма/<?php echo Xmltv_String::strtolower( $this->channel->alias ) ?>/неделя" title=""><?php printf ('Программа передач "%s" на всю неделю', $this->channel->title) ?></a></p>

<?php 
if (!empty($this->programs)) {
?>
<a id="slideshow_onoff" href="#">Показать расписание списком</a>
<div id="programslist" class="carousel">
	<div class="carousel-inner" id="programs-carousel">
	<?php 
	
	///var_dump($this->programs);
	//die(__FILE__.": ".__LINE__);
	
	foreach ($this->programs as $k=>$prog) {
		
		//var_dump($prog);
		//die(__FILE__.': '.__LINE__);
		
		if ($this->is_today)
		$active = $prog->now_showing===true ? ' active' : '' ;
		else
		$active = $k==0 ? ' active' : '' ;
		
		?>
	<div class="item<?php echo $active; ?> programcontainer">
		<div class="programtitle">
		
			<p class="start">
				<span class="start_time"><?php echo $prog->start->toString(Zend_Date::HOUR.':'.Zend_Date::MINUTE) ?></span>
			</p>
		
			<h3>
				<?php $prog_title = $this->truncateProgramTitle($prog->title) ?> 
				<?php if ($this->is_today) : ?>
				<a href="<?php printf( '/телепрограмма/%s/%s/сегодня', $channel_alias, $prog->alias  ); ?>"><?php echo ltrim( trim($prog_title, ':.'), '"'); ?></a>
				<?php else : ?>
				<a href="<?php printf( '/телепрограмма/%s/%s/%s', $channel_alias, $prog->alias, $this->today->toString("yyyy-MM-dd")  ); ?>"><?php echo trim($prog->title, ':') ?></a>
				<?php endif; ?>
			</h3>
			
			<?php if (!empty($prog->sub_title)) : ?>
			<p class="subtitle"><?php echo $prog->sub_title ?></p>
			<?php endif; ?>
			
			<p class="end"><span class="end_time"><?php echo $prog->end->toString('HH:mm') ?></span></p>
			
		</div>
		
		<?php if (!empty($prog->desc_intro)) : ?>
		<p class="desc intro"><?php echo $this->truncateString( $prog->desc_intro, 100, 'words' ) ?></p>
		<?php endif; ?>
		
		<?php if (!empty($prog->desc_body)) : ?>
		<p class="desc body"><?php echo $this->truncateString( $prog->desc_body, 100, 'words' ) ?></p>
		<?php endif; ?>
		
		<?php 
		if (!Xmltv_String::stristr($prog->title, 'новости')) {
			$query = array();
			if (stristr($prog->title, '.')) {
				$parts = explode('.', $prog->title);
				$parts = array_reverse($parts);
				foreach ($parts as $k=>$item) {
					if (!empty($item))
					$query[] = trim( $item );
				}
			}elseif (stristr($prog->title, ':')) {
				$parts = explode(':', $prog->title);
				$parts = array_reverse($parts);
				foreach ($parts as $k=>$item) {
					if (!empty($item))
					$query[] = trim( $item );
				}
			}elseif (stristr($prog->title, '-')) {
				$parts = explode('-', $prog->title);
				$parts = array_reverse($parts);
				foreach ($parts as $k=>$item) {
					if (!empty($item))
					$query[] = trim( $item );
				}
			}  else {
				$query[]=trim( $prog->title );
			}
			//$query[]=$this->channel->title;
			echo $this->youtubeVideos($query, array(
				'max_results'=>1,
				'show_duration'=>false,
				'show_tags'=>10,
				'thumb_width'=>200,
				'safe_search'=>'none',
				'order'=>'published',
				'debug'=>true,
				'truncate_description'=>false), 'content');
		}
		?>
		
	</div>
	<?php 
} ?>
	</div>
	<div id="slides-nav">
		<a data-slide="prev" href="#programslist" class="left carousel-control btn btn-warning">‹</a>
		<a data-slide="next" href="#programslist" class="right carousel-control btn btn-warning">›</a>
	</div>
</div>
<?php
} else {
?>
<p>К сожалению в выбранный вами период программ не найдено. Попробуйте посетить эту страницу позже.</p>
<?php 
}?>


<div class="pager" id="neighbor_days">
	<div class="previous">
		<?php 
		$y = $this->today;
		$y->subDay(1, $y, 'ru'); 
		?>
		<a href="<?php printf ('/телепрограмма/%s/%s', $channel_alias, $y->toString('yyyy-MM-dd')) ?>" title="" class="prev">Программы вчера</a>
	</div>
	<div class="next">
		<?php 
		$t = $this->today;
		$t->addDay(2, $t, 'ru');
		?>
		<a href="<?php printf ('/телепрограмма/%s/%s', $channel_alias, $t->toString('yyyy-MM-dd')) ?>" style="float:right;" class="next" title="">Программы завтра</a>
	</div>
	
</div>

<div class="pager" style="text-align:center;">
	<a class="btn btn-info" id="allchannnels" href="/телепрограмма" title="Все телеканалы">Все каналы</a>
</div>

<?php 
if (!empty($this->comments)) { ?>
<div class="comments">
	<h3><?php printf('Комментарии пользователей про телеканал "%s"', $this->channel->title) ?></h3>
	<br />
	<a href="/комменты/новый">Добавить комментарий</a>
	<?php
	foreach ($this->comments as $comment) {
		//var_dump($comment);
		?>
	<div class="comment">
	
		<div class="title"><?php echo $comment['title'] ?></div>
		
		<div class="author">
			<a href="<?php echo $comment['src_url']  ?>" rel="nofollow" target="_blank">
				<small><?php echo $comment['author'] ?></small>
			</a>
		</div>
		
		<div class="date">
		<?php  
		if (!is_a($comment['date_created'], 'Zend_Date'))
		$date = new Zend_Date($comment['date_created']);
		else
		$date = $comment['date_created'];
		
		echo $date->toString('EEEE, dd MMM yyyy hh:mm');
		?>
		</div>
		
		<div class="intro"><?php echo $comment['intro'] ?></div>
		
		<?php if (!empty($comment['fulltext'])): ?>
		<div class="fulltext"></div>
		<?php endif; ?>
		
	</div>
		<?php 
	}
	?>
</div>
<div class="copy3rdparty">
	<a href="http://blogs.yandex.ru/" title="Yandex поиск по блогам" rel="nofollow"><img src="http://img.yandex.net/i/logo100x43.png" width="37" height="16" /></a>
</div>
<?php 
} ?>