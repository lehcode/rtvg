<?php 
/**
 * Выборанная программа сегодня
 * 
 * @author  Antony Repin
 * @package rutvgid
 * @version $Id: program-day.phtml,v 1.9 2013-03-03 23:34:13 developer Exp $
 *
 */

//var_dump($this->channel);
//die(__FILE__.': '.__LINE__);


/*
 * Channel properties
 */
$channelTitle = $this->escape( $this->channel['title'] );
$channelAlias = $this->escape( $this->channel['alias'] );

/*
 * Generate keywords
 */
$kw = array($channelTitle, $this->date->toString('d MMMM YYYY'), 'сегодня');
if (!empty($this->programs)) {
	foreach ($this->programs as $p) {
		if (count($kw)<5) {
			if (!in_array($p->title, $kw))
			$kw[]= Xmltv_String::strtolower( htmlspecialchars( $p->title, ENT_NOQUOTES, 'utf-8' ) );
		}
	}
}
$this->headMeta()->setName('keywords', implode(',', $kw) );

//var_dump(count($this->programs));
//var_dump($this->programs);
//die(__FILE__.': '.__LINE__);

if (!empty($this->programs)) {

	$programTitle = $this->escape( $this->programs[0]->title );
	$programAlias = $this->escape( $this->programs[0]->alias );
		
	if ($this->is_today) {
		//META title
		$this->headMeta()->setName('title', sprintf ('«%s» сегодня', $programTitle, $channelTitle));
		//page title
		$this->headTitle( sprintf ('Программа «%s» сегодня, %s, на канале «%s»', $programTitle, $this->escape( $this->date->toString('dd MMM')), $channelTitle));
	} else {
		//META title
		$this->headMeta()->setName('title', sprintf ('«%s» %s', $programTitle, $this->escape( $this->date->toString('dd MMM YYYY'))));
		//page title
		$this->headTitle( sprintf ('«%s» на канале «%s» %s', $programTitle, $channelTitle, $this->escape( $this->date->toString('dd MMM YYYY'))));
	}
	/*
	$start_times = array();
	foreach ($this->programs as $single) {
		$start = new Zend_Date( $single->start );
		$start_times[] = $this->escape( $start->toString( "HH:mm" ));
	}
	*/
	?>
	
	<div class="yashare-auto-init" data-yashareL10n="ru" data-yashareType="button" data-yashareQuickServices="vkontakte,facebook,twitter,odnoklassniki,moimir,moikrug,gplus,surfingbird"></div>
	
	<h1><?php echo $programTitle ?> на <?php echo $channelTitle ?></h1>
	
	
	
	<?php if (!empty($this->channel->desc_intro)): ?>
	<p>
		<?php echo strip_tags( $this->channel->desc_intro ) ?>
	</p> 
	<?php endif; ?>
	
	
	
	<p>
		<a href="<?php echo $this->url( array('channel'=>$channelAlias), 'default_listings_day-listing'); ?>">
			<em>Программа <?php echo $channelTitle ?> на сегодня</em>
		</a>	
	</p>
	<p>
		<a href="<?php echo $this->url( array('channel'=>$channelAlias), 'default_channels_channel-week'); ?>">
			<em>Программа <?php echo $channelTitle ?> на неделю</em>
		</a>	
	</p>
	
	
	
	<?php 
	/*
	$channel_link_url = $this->url( array('channel'=>$channelAlias), 'default_channels_channel-week');
	$channel_link = '<a href="'.$this->url( array('channel'=>$channelAlias), 'default_listings_day-listing').'" title="Программа передач канала '.$channelTitle.' на '.$this->escape($this->date->toString('d MMM YYYY')).' ">Телепрограмма '.$channelTitle.' на сегодня</a>';
	$introText = '';
	$program_link_url = $this->url(array('channel'=>$channelAlias, 'alias'=>$programAlias), 'default_listings_program-week');
	$program_link = '<a href="'.$program_link_url.'" title="'.$programTitle.' на этой неделе">'.$programTitle.'</a>';
	if (!$this->is_today)
	$introText = $this->escape( sprintf( 'Программа «%s» выходила в эфир на канале «%s» %s в %s.', $programTitle, $channel_link, $this->date->toString('dd MMMM'), implode(', ', $start_times)));
	if ($this->after_today)
	$introText = $this->escape( sprintf( 'Программа «%s» будет выходить в эфир на канале «%s» %s в %s.', $programTitle, $channel_link, $this->date->toString('dd MMMM'),  implode(', ', $start_times)));
	if (!empty($introText)) {
	?>
	<p>
		<?php
		//$channel_link = '<a href="/телепрограмма/'.$channelAlias.'" title="Программа передач канала '.$channelTitle.' на '.$this->date->toString('d MMM YYYY').' ">'.$channelTitle.'</a>';
		//$program_link = '<a href="/телепрограмма/'.$channelAlias.'/'.$programAlias.'/неделя" title="'.$programTitle.' на этой неделе">'.$programTitle.'</a>';
		$entities = new Zend_Filter_HtmlEntities();
		if ($this->date->isToday())
		printf( $entities->filter('Программа «%s» на канале «%s» сегодня.'), $programTitle, $channel_link); 
		else
		printf( $entities->filter('Программа "%s" выходила в эфир на канале «%s» %s в %s.'), $programTitle, $channel_link, $this->date->toString('dd MMMM'),  implode(', ', $start_times));
		
		
		if (!$this->date->isToday())
		$text = sprintf( $entities->filter('Программа «%s» выходила в эфир на канале «%s» %s в %s.'), $programTitle, $channel_link, $this->date->toString('dd MMMM'),  implode(', ', $start_times));
		if ($this->date->isTomorrow())
		$text = sprintf( $entities->filter('Программа «%s» будет выходить в эфир на канале «%s» %s в %s.'), $programTitle, $channel_link, $this->date->toString('dd MMMM'),  implode(', ', $start_times));
		
		?>
	</p>
	
	<?php 
	}*/ ?>
	
	
	<p class="label label-important">
		<a href="/телепрограмма/<?php echo $channelAlias.'/'.$programAlias?>/неделя" title="<?php echo $this->escape( sprintf("Все выпуски программы «%s» на этой неделе", $programTitle)) ?>">
			Искать <?php echo '"' . $programTitle . '"'?> на этой неделе
		</a>
	</p>


	<table class="table table-condensed">
		<caption><?php echo sprintf ("<strong>«%s»</strong> %s", $programTitle, $this->date->toString(Zend_Date::DATE_FULL)) ?></caption>
		<tbody>
			<?php
			foreach ($this->programs as $single) {
				//var_dump($single);
				$start = new Zend_Date($single->start, null, 'ru');
			?>
			<tr>
				<td><?php echo $this->escape( $start->toString( "HH:mm" )); ?></td>
				<td><?php echo $this->escape( $single->title ) ?></td>
			</tr>
			
			<?php 
	}
	?>
		</tbody>
	</table>
	
	
	
	<?php
	
	
	
} else {
	
	/*
	 * Set META title
	 */
	if ($this->is_today) {
		$this->headMeta()->setName('title', "Эта программа сегодня не выходит");
	} else {
		$this->headMeta()->setName('title', sprintf ('Эта программа не выходит в эфир %s', $this->escape( $this->date->toString('dd MMM YYYY'))));
	}
	$this->headMeta()->setName('robots', 'noidex,follow');
	/*
	 * Set page title
	 */
	if ($this->is_today) {
		$this->headTitle( "Эта программа сегодня не выходит в эфир");
	} else {
		$this->headTitle( sprintf ('Эта программа не выходит в эфир %s', $this->escape( $this->date->toString('dd MMM YYYY'))));
	}
	?>
	<h2>Канал <?php echo $channelTitle ?></h2>
	<?php if (!empty($this->channel->desc_intro)): ?>
	<p><?php echo strip_tags( $this->channel->desc_intro ) ?></p> 
	<?php endif; ?>
	
	<p>Эта программа сегодня не выходит в эфир на канале <?php echo $channelTitle ?>.<br />
	<a class="btn btn-mini" href="/телепрограмма/<?php echo $channelAlias ?>">Программа <?php echo $channelTitle ?> на сегодня, <?php echo $this->escape( $this->date->toString('dd MMM YYYY')) ?></a>
	
<?php 

} ?>
<?php //die(__FILE__.': '.__LINE__); ?>




