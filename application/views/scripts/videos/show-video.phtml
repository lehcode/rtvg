<?php
/**
 * Video page view script
 * 
 * @author  Antony Repin
 * @package rutvgid
 * @version $Id: show-video.phtml,v 1.10 2013-01-12 09:06:22 developer Exp $
 *
 */

//var_dump($this->main_video->getVideoTitle());
//die(__FILE__.': '.__LINE__);

if (isset($this->main_video)){
    
    $videoTitle = Xmltv_String::ucfirst( Xmltv_String::strtolower( $this->main_video->getVideoTitle() ));
    if ($videoTitle) {
    	$this->headTitle( sprintf("%s :: онлайн на rutvgid.ru", str_replace("\n", ' ', $videoTitle)));
    }
    
    $videoDesc = $this->main_video->getVideoDescription();
    if ($videoDesc) {
    	$this->headMeta()->setName( 'description', $this->truncateString( str_replace( "\n", ' ', $videoDesc), 12, 'words'));
    }
    
    $vidId = $this->main_video->getVideoId();
    $this->inlineScript()->appendFile("/js/swfobject/swfobject.js");
    $this->headScript()->appendScript("$(document).ready(function() {
    		var descP = $('.video.thumbnails .span4 p.desc');
    		var descHeight = descP.prop('offsetHeight');
    		if (descHeight>150) { descP.css({ height:'8.4em' }).after('<button class=\"btn\" id=\"fulldesc\">Читать полностью</a>'); }
    		$('#fulldesc').click( function(e){ descP.css({ height:descHeight }); $(this).hide(500); });
    
    });");
    ?>
    
    <div class="page videos">
	<?php /*
	<div style="width:100%;">
		<div style="width:400px; height:175px; margin: 1.5em auto;">
			<a href="<?php echo $banner['url'] ?>" target="_blank">
				<img src="http://rutvgid.ru/<?php echo $banner['image'] ?>" alt="<?php echo $banner['title'] ?>" />
			</a>
		</div>
		<p class="desc"><?php echo strip_tags( $videoDesc ) ?></p>
	</div>
	*/ ?>

	<div class="video main">
	
		<h1><?php echo $videoTitle ?></h1>
		<div class="player-wrap">
			<div id="player">Для просмотра этого видео нужна поддержка Flash player 8+ и JavaScript в вашем браузере.</div>
		</div>
		<p class="desc"><?php echo strip_tags( $videoDesc ) ?></p>
		<?php 
		$this->inlineScript()->appendScript('var params = { allowScriptAccess: "always", allowfullscreen:"true" };
	    var attrs = { id: "mytplayer" };
	    swfobject.embedSWF("http://www.youtube.com/v/'.$vidId.'?enablejsapi=1&playerapiid=ytplayer&version=3&allowfullscreen=true", "player", "460", "258", "8", null, null, params, attrs);');
		?>
	</div>
	
	<div class="related">
	<?php 
	//$grid_columns = 1;
	//$col_width_pct = floor(100/$grid_columns)-1;
	//$amount=(int)Zend_Registry::get('site_config')->videos->related->get('amount');
	if ($this->related_videos){
		foreach ($this->related_videos as $v) {
		
		$current = $v;
		
		if (!preg_match('/\p{Cyrillic}+/ui', $current->getVideoTitle()))
		continue;
		
		?>
		<div class="video">
			
			<?php 
			$title = $current->getVideoTitle();
			$vid   = Xmltv_Youtube::genRtvgId( $current->getVideoId() );
			$alias = Xmltv_Youtube::videoAlias( $title);
			?>
			
			<h3 class="title">
				<a href="<?php echo $this->url( array('alias'=>$alias, 'id'=>$vid), 'default_videos_show-video' )  ?>" title="Смотреть онлайн <?php echo $title ?>" target="_blank"><?php echo $title ?></a></h2>
			</h3>
		
			<div class="image">
				
				<?php 
				try {
					$videoThumbnails = $current->getVideoThumbnails();
				} catch (Exception $e) {
					echo $e->getMessage();
				}
				$k=0;
				foreach($videoThumbnails as $videoThumbnail) {
					if ($videoThumbnail['width'] >= 200) {
						
						?>
						<a class="imagelink" href="<?php echo $this->url( array('alias'=>Xmltv_Youtube::videoAlias( $title), 'id'=>$vid), 'default_videos_show-video' ) ?>">
							<img src="<?php echo $videoThumbnail['url'] ?>" width="240" alt="<?php echo $title ?>" />
						</a>
						
						<?php 
						break;
					}
					$k++;
				}
				
				?>
				
				<p class="viewcount">Посмотрели: <?php echo number_format( (int)$current->getVideoViewCount(), 0 ) ?></p>
				
				<p class="category">
					<?php 
					$catEn = $current->getVideoCategory();
					$catRu = Xmltv_Youtube::getCatRu($catEn); 
					if ($catRu==$catEn) {
					?>
					Категория: <?php echo $catEn; ?>
					<?php 
					} else {
						?>
						Категория: 
						<a href="<?php echo $this->url( array('category'=>Xmltv_String::strtolower( $catRu )), 'default_channels_category'); ?>"
						target="_blank"
						title="<?php $catRu ?> каналы телепрограмма">
						<?php echo $catRu; ?>
					</a>
						<?php 
					}?>
					 
				</p>
				
				<p class="date">
					<?php $date = new Zend_Date ( $current->getUpdated() ); ?>
					Добавлено <?php echo $date->toString('d MMM YYYY');  ?>
				</p>
				
			</div>
				
			<div class="description">
				
				
				
				<?php
				$desc = $this->truncateString( $current->getVideoDescription(), 35, 'words' );
				if (!empty($desc)) {
					?>
				<p>
					<?php echo $desc ?>
				</p>
					<?php 
				} ?>
				
			</div>
			
		</div>
		<?php 
		}
	} ?>
		
	</div>
	
</div>
    
    <?php 
} else {
    $this->headMeta()->setName( 'description', "Not found!" );
    $this->headMeta()->setName( 'robots', 'noindex,follow' );
}



